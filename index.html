<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”³è«‹æ¬Šé™è¨˜éŒ„ç³»çµ±</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            border-right: 1px solid #eaeaea;
        }
        
        .records-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5298;
            color: #1e3c72;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2a5298;
            outline: none;
            box-shadow: 0 0 5px rgba(42, 82, 152, 0.3);
        }
        
        .checkbox-group {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eaeaea;
            padding: 15px;
            border-radius: 5px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .checkbox-item input {
            width: auto;
            margin-right: 8px;
        }
        
        button {
            background-color: #2a5298;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #1e3c72;
        }
        
        .btn-export {
            background-color: #28a745;
        }
        
        .btn-export:hover {
            background-color: #218838;
        }
        
        .btn-sync {
            background-color: #6f42c1;
        }
        
        .btn-sync:hover {
            background-color: #5a359c;
        }
        
        .management-section {
            margin-top: 30px;
            border-top: 1px solid #eaeaea;
            padding-top: 20px;
        }
        
        .management-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .management-controls input {
            flex: 1;
            min-width: 150px;
        }
        
        .records-list {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eaeaea;
            border-radius: 5px;
            padding: 15px;
        }
        
        .record-item {
            padding: 15px;
            border-bottom: 1px solid #eaeaea;
            background-color: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .record-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .record-details {
            color: #666;
            font-size: 14px;
        }
        
        .empty-message {
            text-align: center;
            color: #888;
            padding: 20px;
        }
        
        .no-border {
            border: none;
        }
        
        .search-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f4f8;
            border-radius: 5px;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-controls input {
            flex: 1;
            min-width: 200px;
        }
        
        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* é›²ç«¯åŒæ­¥è¨­ç½®å€åŸŸ - ç¢ºä¿å¯è¦‹ */
        .sync-section {
            margin: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border: 2px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sync-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .sync-controls input {
            flex: 1;
            min-width: 250px;
            padding: 10px;
        }
        
        .sync-instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2a5298;
            margin-top: 15px;
        }
        
        .sync-instructions h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }
        
        .sync-instructions ol {
            margin-left: 20px;
        }
        
        .sync-instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .employee-summary {
            background-color: #e8f4fd;
            border-left: 4px solid #2a5298;
        }
        
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .summary-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        
        .application-count {
            background-color: #2a5298;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
            }
            
            .checkbox-group {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .checkbox-group {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .form-section, .records-section {
                border-right: none;
                border-bottom: 1px solid #eaeaea;
            }
            
            .search-controls, .export-controls, .sync-controls {
                flex-direction: column;
            }
            
            .search-controls input, .export-controls select, .sync-controls input {
                width: 100%;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç”³è«‹æ¬Šé™è¨˜éŒ„ç³»çµ±</h1>
            <p class="subtitle">æ¬Šé™ç”³è«‹èˆ‡ç®¡ç†å¹³å° - å¤šè¨­å‚™åŒæ­¥ç‰ˆ</p>
        </header>
        
        <!-- é›²ç«¯åŒæ­¥è¨­ç½®å€åŸŸ - ç¢ºä¿åœ¨é ‚éƒ¨é¡¯ç¤º -->
        <div class="sync-section">
            <h2 class="section-title">ğŸ”— é›²ç«¯åŒæ­¥è¨­ç½®</h2>
            <div class="sync-controls">
                <input type="password" id="githubToken" placeholder="è¼¸å…¥ GitHub Personal Access Token">
                <input type="text" id="gistId" placeholder="Gist ID (ç•™ç©ºå°‡å‰µå»ºæ–°çš„)">
                <button id="saveSyncBtn" class="btn-sync">ä¿å­˜åŒæ­¥è¨­ç½®</button>
                <button id="syncDataBtn" class="btn-sync">åŒæ­¥æ•¸æ“š</button>
            </div>
            <div id="syncStatus"></div>
            
            <div class="sync-instructions">
                <h4>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼š</h4>
                <ol>
                    <li><strong>å‰µå»º GitHub Tokenï¼š</strong>
                        <ul>
                            <li>ç™»éŒ„ GitHub â†’ é»æ“Šé ­åƒ â†’ Settings</li>
                            <li>å·¦å´é¸æ“‡ Developer settings â†’ Personal access tokens â†’ Tokens (classic)</li>
                            <li>é»æ“Š Generate new token â†’ å‹¾é¸ gist æ¬Šé™ â†’ ç”Ÿæˆä¸¦è¤‡è£½ token</li>
                        </ul>
                    </li>
                    <li><strong>è¨­ç½®åŒæ­¥ï¼š</strong>
                        <ul>
                            <li>åœ¨ä¸Šé¢è¼¸å…¥ GitHub Token</li>
                            <li>Gist ID ç•™ç©ºï¼ˆç³»çµ±æœƒè‡ªå‹•å‰µå»ºï¼‰</li>
                            <li>é»æ“Šã€Œä¿å­˜åŒæ­¥è¨­ç½®ã€</li>
                        </ul>
                    </li>
                    <li><strong>å¤šè¨­å‚™åŒæ­¥ï¼š</strong>
                        <ul>
                            <li>åœ¨å…¶ä»–è¨­å‚™è¼¸å…¥ç›¸åŒçš„ Token å’Œ Gist ID</li>
                            <li>é»æ“Šã€ŒåŒæ­¥æ•¸æ“šã€å³å¯åŒæ­¥æ‰€æœ‰æ•¸æ“š</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">ğŸ“ ç”³è«‹è¡¨å–®</h2>
                
                <div class="form-group">
                    <label for="employeeId">å·¥è™Ÿ</label>
                    <input type="text" id="employeeId" placeholder="è«‹è¼¸å…¥æ‚¨çš„å·¥è™Ÿ">
                </div>
                
                <div class="form-group">
                    <label for="applicationNo">ç”³è«‹å–®è™Ÿ</label>
                    <input type="text" id="applicationNo" placeholder="è«‹è¼¸å…¥ç”³è«‹å–®è™Ÿ">
                </div>
                
                <div class="form-group">
                    <label for="applicationType">ç”³è«‹å–®é¡å‹</label>
                    <select id="applicationType">
                        <option value="">-- è«‹é¸æ“‡ç”³è«‹å–®é¡å‹ --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ç”³è«‹é …ç›®</label>
                    <div class="checkbox-group" id="applicationItems">
                        <!-- å‹•æ…‹ç”Ÿæˆçš„ç”³è«‹é …ç›® -->
                    </div>
                </div>
                
                <button id="submitBtn">æäº¤ç”³è«‹</button>
            </div>
            
            <div class="records-section">
                <h2 class="section-title">ğŸ“Š ç”³è«‹è¨˜éŒ„</h2>
                
                <div class="search-section">
                    <div class="search-controls">
                        <input type="text" id="searchInput" placeholder="æœå°‹å·¥è™Ÿã€ç”³è«‹å–®è™Ÿæˆ–ç”³è«‹é¡å‹">
                        <button id="searchBtn">æœå°‹</button>
                        <button id="clearSearchBtn">æ¸…é™¤æœå°‹</button>
                        
                        <div class="export-controls">
                            <select id="exportType">
                                <option value="all">åŒ¯å‡ºæ‰€æœ‰è¨˜éŒ„</option>
                                <option value="search">åŒ¯å‡ºæœå°‹çµæœ</option>
                                <option value="lastMonth">åŒ¯å‡ºæœ€è¿‘ä¸€å€‹æœˆè¨˜éŒ„</option>
                            </select>
                            <button id="exportBtn" class="btn-export">åŒ¯å‡ºç‚ºExcel</button>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="checkbox" id="groupByEmployee">
                        <label for="groupByEmployee">æŒ‰å·¥è™Ÿåˆ†çµ„é¡¯ç¤º</label>
                    </div>
                </div>
                
                <div class="records-list" id="recordsList">
                    <!-- å‹•æ…‹ç”Ÿæˆçš„ç”³è«‹è¨˜éŒ„ -->
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <div class="management-section">
                    <h2 class="section-title">âš™ï¸ ç”³è«‹å–®é¡å‹ç®¡ç†</h2>
                    
                    <div class="management-controls">
                        <input type="text" id="newType" placeholder="æ–°å¢ç”³è«‹å–®é¡å‹">
                        <button id="addTypeBtn">æ–°å¢é¡å‹</button>
                    </div>
                    
                    <div class="management-controls">
                        <select id="typeToDelete">
                            <option value="">-- é¸æ“‡è¦åˆªé™¤çš„é¡å‹ --</option>
                        </select>
                        <button id="deleteTypeBtn">åˆªé™¤é¡å‹</button>
                    </div>
                </div>
            </div>
            
            <div class="records-section">
                <div class="management-section">
                    <h2 class="section-title">ğŸ”§ ç”³è«‹é …ç›®ç®¡ç†</h2>
                    
                    <div class="management-controls">
                        <select id="typeForItem">
                            <option value="">-- é¸æ“‡ç”³è«‹å–®é¡å‹ --</option>
                        </select>
                        <input type="text" id="newItem" placeholder="æ–°å¢ç”³è«‹é …ç›®">
                        <button id="addItemBtn">æ–°å¢é …ç›®</button>
                    </div>
                    
                    <div class="management-controls">
                        <select id="typeForDeleteItem">
                            <option value="">-- é¸æ“‡ç”³è«‹å–®é¡å‹ --</option>
                        </select>
                        <select id="itemToDelete">
                            <option value="">-- é¸æ“‡è¦åˆªé™¤çš„é …ç›® --</option>
                        </select>
                        <button id="deleteItemBtn">åˆªé™¤é …ç›®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ•¸æ“šçµæ§‹
        let applicationData = {
            types: [],
            items: {},
            records: []
        };

        // åŒæ­¥è¨­ç½®
        let syncConfig = {
            githubToken: '',
            gistId: ''
        };

        // DOMå…ƒç´ 
        const employeeIdInput = document.getElementById('employeeId');
        const applicationNoInput = document.getElementById('applicationNo');
        const applicationTypeSelect = document.getElementById('applicationType');
        const applicationItemsDiv = document.getElementById('applicationItems');
        const submitBtn = document.getElementById('submitBtn');
        const recordsList = document.getElementById('recordsList');
        
        // åŒæ­¥ç›¸é—œå…ƒç´ 
        const githubTokenInput = document.getElementById('githubToken');
        const gistIdInput = document.getElementById('gistId');
        const saveSyncBtn = document.getElementById('saveSyncBtn');
        const syncDataBtn = document.getElementById('syncDataBtn');
        const syncStatusDiv = document.getElementById('syncStatus');
        
        // æœå°‹ç›¸é—œå…ƒç´ 
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const groupByEmployeeCheckbox = document.getElementById('groupByEmployee');
        
        // å°å‡ºç›¸é—œå…ƒç´ 
        const exportTypeSelect = document.getElementById('exportType');
        const exportBtn = document.getElementById('exportBtn');
        
        // ç®¡ç†ç›¸é—œå…ƒç´ 
        const newTypeInput = document.getElementById('newType');
        const addTypeBtn = document.getElementById('addTypeBtn');
        const typeToDeleteSelect = document.getElementById('typeToDelete');
        const deleteTypeBtn = document.getElementById('deleteTypeBtn');
        
        const typeForItemSelect = document.getElementById('typeForItem');
        const newItemInput = document.getElementById('newItem');
        const addItemBtn = document.getElementById('addItemBtn');
        const typeForDeleteItemSelect = document.getElementById('typeForDeleteItem');
        const itemToDeleteSelect = document.getElementById('itemToDelete');
        const deleteItemBtn = document.getElementById('deleteItemBtn');

        // é¡¯ç¤ºç‹€æ…‹æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            syncStatusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                syncStatusDiv.innerHTML = '';
            }, 5000);
        }

        // å¾localStorageåŠ è¼‰æ•¸æ“šå’Œè¨­ç½®
        function loadData() {
            // åŠ è¼‰åŒæ­¥è¨­ç½®
            const savedSyncConfig = localStorage.getItem('syncConfig');
            if (savedSyncConfig) {
                syncConfig = JSON.parse(savedSyncConfig);
                githubTokenInput.value = syncConfig.githubToken;
                gistIdInput.value = syncConfig.gistId;
            }
            
            // åŠ è¼‰æ‡‰ç”¨æ•¸æ“š
            const savedData = localStorage.getItem('applicationData');
            if (savedData) {
                try {
                    applicationData = JSON.parse(savedData);
                showStatus('æœ¬åœ°æ•¸æ“šåŠ è¼‰æˆåŠŸ', 'success');
                console.log('åŠ è¼‰çš„æ•¸æ“š:', applicationData);
                console.log('è¨˜éŒ„æ•¸é‡:', applicationData.records.length);
                console.log('é¡å‹æ•¸é‡:', applicationData.types.length);
                console.log('é …ç›®:', applicationData.items);
                } catch (e) {
                console.error('è§£æå­˜å„²æ•¸æ“šæ™‚å‡ºéŒ¯:', e);
                initializeDefaultData();
            }
            } else {
                initializeDefaultData();
            }
            
            updateTypeSelects();
            updateItemsForSelectedType();
            displayRecords();
        }

        // åˆå§‹åŒ–é»˜èªæ•¸æ“š
        function initializeDefaultData() {
            console.log('åˆå§‹åŒ–é»˜èªæ•¸æ“š');
            applicationData.types = ['ç³»çµ±æ¬Šé™', 'é–€ç¦æ¬Šé™', 'è¨­å‚™æ¬Šé™'];
            applicationData.items = {
                'ç³»çµ±æ¬Šé™': ['ERPç³»çµ±', 'CRMç³»çµ±', 'è²¡å‹™ç³»çµ±', 'äººäº‹ç³»çµ±', 'æ¡è³¼ç³»çµ±', 'åº«å­˜ç®¡ç†'],
                'é–€ç¦æ¬Šé™': ['è¾¦å…¬å®¤å€åŸŸ', 'å¯¦é©—å®¤å€åŸŸ', 'å€‰åº«å€åŸŸ', 'æœƒè­°å®¤å€åŸŸ', 'ä¼‘æ¯å®¤å€åŸŸ', 'è³‡æ–™ä¸­å¿ƒ'],
                'è¨­å‚™æ¬Šé™': ['å°è¡¨æ©Ÿ', 'æŠ•å½±æ©Ÿ', 'æœƒè­°å®¤è¨­å‚™', 'æƒæå™¨', 'å½±å°æ©Ÿ', 'å‚³çœŸæ©Ÿ']
            };
            
            // æ·»åŠ ä¸€äº›ç¤ºä¾‹è¨˜éŒ„
            const now = new Date();
            applicationData.records = [
                {
                    employeeId: 'E001',
                    applicationNo: 'APP2023001',
                    applicationType: 'ç³»çµ±æ¬Šé™',
                    selectedItems: ['ERPç³»çµ±', 'CRMç³»çµ±'],
                    timestamp: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    employeeId: 'E002',
                    applicationNo: 'APP2023002',
                    applicationType: 'é–€ç¦æ¬Šé™',
                    selectedItems: ['è¾¦å…¬å®¤å€åŸŸ', 'å¯¦é©—å®¤å€åŸŸ'],
                    timestamp: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    employeeId: 'E001',
                    applicationNo: 'APP2023003',
                    applicationType: 'è¨­å‚™æ¬Šé™',
                    selectedItems: ['å°è¡¨æ©Ÿ', 'æŠ•å½±æ©Ÿ'],
                    timestamp: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString()
                }
            ];
            
            saveDataToLocal();
            showStatus('é»˜èªæ•¸æ“šåˆå§‹åŒ–å®Œæˆ', 'success');
        }

        // ä¿å­˜æ•¸æ“šåˆ°localStorage
        function saveDataToLocal() {
            try {
                localStorage.setItem('applicationData', JSON.stringify(applicationData));
                console.log('æ•¸æ“šå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å„²');
            } catch (e) {
                console.error('ä¿å­˜æ•¸æ“šæ™‚å‡ºéŒ¯:', e);
                alert('ä¿å­˜æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨å­˜å„²ç©ºé–“ã€‚');
            }
        }

        // ä¿å­˜åŒæ­¥è¨­ç½®
        function saveSyncConfig() {
            syncConfig.githubToken = githubTokenInput.value.trim();
            syncConfig.gistId = gistIdInput.value.trim();
            
            try {
                localStorage.setItem('syncConfig', JSON.stringify(syncConfig));
                showStatus('åŒæ­¥è¨­ç½®å·²ä¿å­˜', 'success');
                console.log('åŒæ­¥è¨­ç½®å·²ä¿å­˜:', syncConfig);
            } catch (e) {
                console.error('ä¿å­˜åŒæ­¥è¨­ç½®æ™‚å‡ºéŒ¯:', e);
                showStatus('ä¿å­˜åŒæ­¥è¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // ä¸Šå‚³æ•¸æ“šåˆ° GitHub Gist
        async function uploadToGist() {
            if (!syncConfig.githubToken) {
                showStatus('è«‹å…ˆè¨­ç½® GitHub Token', 'error');
                return null;
            }
            
            try {
                showStatus('æ­£åœ¨ä¸Šå‚³æ•¸æ“šåˆ°é›²ç«¯...', 'info');
                
                const gistData = {
                    description: 'ç”³è«‹æ¬Šé™è¨˜éŒ„ç³»çµ±æ•¸æ“š - ' + new Date().toLocaleString(),
                    public: false,
                    files: {
                        'application-data.json': {
                            content: JSON.stringify(applicationData, null, 2)
                        }
                    }
                };
                
                let url = 'https://api.github.com/gists';
                let method = 'POST';
                
                if (syncConfig.gistId) {
                    url = `https://api.github.com/gists/${syncConfig.gistId}`;
                    method = 'PATCH';
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${syncConfig.githubToken}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub API éŒ¯èª¤: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                
                if (!syncConfig.gistId) {
                    syncConfig.gistId = result.id;
                    gistIdInput.value = result.id;
                    localStorage.setItem('syncConfig', JSON.stringify(syncConfig));
                    showStatus(`Gist å‰µå»ºæˆåŠŸï¼Gist ID: ${result.id}`, 'success');
                } else {
                    showStatus('æ•¸æ“šä¸Šå‚³æˆåŠŸ', 'success');
                }
                
                return result;
            } catch (error) {
                console.error('ä¸Šå‚³æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
                showStatus(`ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
                return null;
            }
        }

        // å¾ GitHub Gist ä¸‹è¼‰æ•¸æ“š
        async function downloadFromGist() {
            if (!syncConfig.githubToken || !syncConfig.gistId) {
                showStatus('è«‹å…ˆè¨­ç½® GitHub Token å’Œ Gist ID', 'error');
                return false;
            }
            
            try {
                showStatus('æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰æ•¸æ“š...', 'info');
                
                const response = await fetch(`https://api.github.com/gists/${syncConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${syncConfig.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`GitHub API éŒ¯èª¤: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const gist = await response.json();
                const fileContent = gist.files['application-data.json'].content;
                
                applicationData = JSON.parse(fileContent);
                saveDataToLocal();
                updateTypeSelects();
                updateItemsForSelectedType();
                displayRecords();
                
                showStatus('æ•¸æ“šåŒæ­¥æˆåŠŸ', 'success');
                return true;
            } catch (error) {
                console.error('ä¸‹è¼‰æ•¸æ“šæ™‚å‡ºéŒ¯:', error);
                showStatus(`åŒæ­¥å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }

        // åŒæ­¥æ•¸æ“šï¼ˆä¸Šå‚³å’Œä¸‹è¼‰ï¼‰
        async function syncData() {
            showStatus('æ­£åœ¨åŒæ­¥æ•¸æ“š...', 'info');
            
            // å…ˆä¸Šå‚³ç•¶å‰æ•¸æ“š
            const uploadResult = await uploadToGist();
            if (uploadResult) {
                // ç„¶å¾Œä¸‹è¼‰æœ€æ–°æ•¸æ“šï¼ˆè§£æ±ºè¡çªï¼‰
                await downloadFromGist();
            }
        }

        // æ›´æ–°æ‰€æœ‰é¡å‹ä¸‹æ‹‰é¸å–®
        function updateTypeSelects() {
            // æ¸…ç©ºæ‰€æœ‰é¡å‹ä¸‹æ‹‰é¸å–®
            const typeSelects = [
                applicationTypeSelect,
                typeToDeleteSelect,
                typeForItemSelect,
                typeForDeleteItemSelect
            ];
            
            typeSelects.forEach(select => {
                // ä¿å­˜ç•¶å‰é¸æ“‡çš„å€¼
                const currentValue = select.value;
                
                // æ¸…ç©ºé¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹é¸é …ï¼‰
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // æ·»åŠ é¡å‹é¸é …
                applicationData.types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    select.appendChild(option);
                });
                
                // æ¢å¾©ä¹‹å‰çš„é¸æ“‡ï¼ˆå¦‚æœä»ç„¶å­˜åœ¨ï¼‰
                if (applicationData.types.includes(currentValue)) {
                    select.value = currentValue;
                }
            });
            
            // æ›´æ–°é …ç›®ä¸‹æ‹‰é¸å–®
            updateItemDeleteSelect();
        }

        // æ›´æ–°ç”³è«‹é …ç›®é¡¯ç¤º
        function updateItemsForSelectedType() {
            const selectedType = applicationTypeSelect.value;
            applicationItemsDiv.innerHTML = '';
            
            if (selectedType && applicationData.items[selectedType]) {
                applicationData.items[selectedType].forEach(item => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `item-${item.replace(/\s+/g, '-')}`;
                    checkbox.value = item;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `item-${item.replace(/\s+/g, '-')}`;
                    label.textContent = item;
                    
                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    applicationItemsDiv.appendChild(checkboxItem);
                });
            } else {
                applicationItemsDiv.innerHTML = '<div class="empty-message">è«‹å…ˆé¸æ“‡ç”³è«‹å–®é¡å‹</div>';
            }
        }

        // æ›´æ–°é …ç›®åˆªé™¤ä¸‹æ‹‰é¸å–®
        function updateItemDeleteSelect() {
            const selectedType = typeForDeleteItemSelect.value;
            itemToDeleteSelect.innerHTML = '<option value="">-- é¸æ“‡è¦åˆªé™¤çš„é …ç›® --</option>';
            
            if (selectedType && applicationData.items[selectedType]) {
                applicationData.items[selectedType].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    itemToDeleteSelect.appendChild(option);
                });
            }
        }

        // é¡¯ç¤ºç”³è«‹è¨˜éŒ„
        function displayRecords(searchTerm = '', groupByEmployee = false) {
            recordsList.innerHTML = '';
            
            let filteredRecords = applicationData.records;
            
            // å¦‚æœæœ‰æœå°‹æ¢ä»¶ï¼Œéæ¿¾è¨˜éŒ„
            if (searchTerm) {
                filteredRecords = applicationData.records.filter(record => 
                    record.employeeId.includes(searchTerm) || 
                    record.applicationNo.includes(searchTerm) || 
                    record.applicationType.includes(searchTerm) ||
                    record.selectedItems.some(item => item.includes(searchTerm))
                );
            }
            
            if (filteredRecords.length === 0) {
                recordsList.innerHTML = '<div class="empty-message">æš«ç„¡ç”³è«‹è¨˜éŒ„</div>';
                return;
            }
            
            // æŒ‰æ™‚é–“å€’åºé¡¯ç¤ºè¨˜éŒ„
            filteredRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // å¦‚æœé¸æ“‡æŒ‰å·¥è™Ÿåˆ†çµ„
            if (groupByEmployee) {
                displayGroupedRecords(filteredRecords);
            } else {
                displayDetailedRecords(filteredRecords);
            }
        }

        // é¡¯ç¤ºè©³ç´°è¨˜éŒ„ï¼ˆæ¯ç­†è¨˜éŒ„å–®ç¨é¡¯ç¤ºï¼‰
        function displayDetailedRecords(records) {
            records.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                const recordHeader = document.createElement('div');
                recordHeader.className = 'record-header';
                recordHeader.innerHTML = `
                    <span>å·¥è™Ÿ: ${record.employeeId}</span>
                    <span>${new Date(record.timestamp).toLocaleString()}</span>
                `;
                
                const recordDetails = document.createElement('div');
                recordDetails.className = 'record-details';
                recordDetails.innerHTML = `
                    <p><strong>ç”³è«‹å–®è™Ÿ:</strong> ${record.applicationNo}</p>
                    <p><strong>ç”³è«‹å–®é¡å‹:</strong> ${record.applicationType}</p>
                    <p><strong>ç”³è«‹é …ç›®:</strong> ${record.selectedItems.join(', ')}</p>
                `;
                
                recordItem.appendChild(recordHeader);
                recordItem.appendChild(recordDetails);
                recordsList.appendChild(recordItem);
            });
        }

        // é¡¯ç¤ºåˆ†çµ„è¨˜éŒ„ï¼ˆæŒ‰å·¥è™Ÿåˆ†çµ„ï¼‰
        function displayGroupedRecords(records) {
            // æŒ‰å·¥è™Ÿåˆ†çµ„
            const groupedRecords = {};
            records.forEach(record => {
                if (!groupedRecords[record.employeeId]) {
                    groupedRecords[record.employeeId] = [];
                }
                groupedRecords[record.employeeId].push(record);
            });
            
            // é¡¯ç¤ºæ¯å€‹å·¥è™Ÿçš„ç¸½çµ
            Object.keys(groupedRecords).forEach(employeeId => {
                const employeeRecords = groupedRecords[employeeId];
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item employee-summary';
                
                const summaryHeader = document.createElement('div');
                summaryHeader.className = 'summary-header';
                summaryHeader.innerHTML = `
                    <span>å·¥è™Ÿ: ${employeeId}</span>
                    <span class="application-count">${employeeRecords.length} ç­†ç”³è«‹</span>
                `;
                
                const summaryDetails = document.createElement('div');
                summaryDetails.className = 'summary-details';
                
                // çµ±è¨ˆç”³è«‹é¡å‹å’Œé …ç›®
                const typeCount = {};
                const itemCount = {};
                
                employeeRecords.forEach(record => {
                    // çµ±è¨ˆç”³è«‹é¡å‹
                    typeCount[record.applicationType] = (typeCount[record.applicationType] || 0) + 1;
                    
                    // çµ±è¨ˆç”³è«‹é …ç›®
                    record.selectedItems.forEach(item => {
                        itemCount[item] = (itemCount[item] || 0) + 1;
                    });
                });
                
                // é¡¯ç¤ºç”³è«‹é¡å‹çµ±è¨ˆ
                const typeList = Object.keys(typeCount).map(type => 
                    `${type} (${typeCount[type]}æ¬¡)`
                ).join(', ');
                
                // é¡¯ç¤ºç”³è«‹é …ç›®çµ±è¨ˆ
                const itemList = Object.keys(itemCount).map(item => 
                    `${item} (${itemCount[item]}æ¬¡)`
                ).join(', ');
                
                summaryDetails.innerHTML = `
                    <p><strong>ç”³è«‹é¡å‹:</strong> ${typeList}</p>
                    <p><strong>ç”³è«‹é …ç›®:</strong> ${itemList}</p>
                    <p><strong>æœ€è¿‘ç”³è«‹æ™‚é–“:</strong> ${new Date(employeeRecords[0].timestamp).toLocaleString()}</p>
                `;
                
                recordItem.appendChild(summaryHeader);
                recordItem.appendChild(summaryDetails);
                recordsList.appendChild(recordItem);
            });
        }

        // åŒ¯å‡ºç‚ºExcel
        function exportToExcel() {
            const exportType = exportTypeSelect.value;
            let recordsToExport = [];
            
            // æ ¹æ“šåŒ¯å‡ºé¡å‹é¸æ“‡è¨˜éŒ„
            switch(exportType) {
                case 'all':
                    recordsToExport = applicationData.records;
                    break;
                case 'search':
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm) {
                        recordsToExport = applicationData.records.filter(record => 
                            record.employeeId.includes(searchTerm) || 
                            record.applicationNo.includes(searchTerm) || 
                            record.applicationType.includes(searchTerm) ||
                            record.selectedItems.some(item => item.includes(searchTerm))
                        );
                    } else {
                        recordsToExport = applicationData.records;
                    }
                    break;
                case 'lastMonth':
                    const oneMonthAgo = new Date();
                    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                    recordsToExport = applicationData.records.filter(record => 
                        new Date(record.timestamp) >= oneMonthAgo
                    );
                    break;
            }
            
            if (recordsToExport.length === 0) {
                alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }
            
            try {
                // æº–å‚™Excelæ•¸æ“š
                const excelData = [
                    ['å·¥è™Ÿ', 'ç”³è«‹å–®è™Ÿ', 'ç”³è«‹å–®é¡å‹', 'ç”³è«‹é …ç›®', 'ç”³è«‹æ™‚é–“']
                ];
                
                recordsToExport.forEach(record => {
                    excelData.push([
                        record.employeeId,
                        record.applicationNo,
                        record.applicationType,
                        record.selectedItems.join(', '),
                        new Date(record.timestamp).toLocaleString('zh-TW')
                    ]);
                });
                
                // å‰µå»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ç”³è«‹è¨˜éŒ„');
                
                // ç”Ÿæˆæª”æ¡ˆåç¨±
                const fileName = `ç”³è«‹è¨˜éŒ„_${new Date().toISOString().slice(0, 10)}.xlsx`;
                
                // åŒ¯å‡ºExcelæª”æ¡ˆ
                XLSX.writeFile(wb, fileName);
            } catch (error) {
                console.error('åŒ¯å‡ºExcelæ™‚å‡ºéŒ¯:', error);
                alert('åŒ¯å‡ºExcelæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }

        // äº‹ä»¶ç›£è½å™¨
        applicationTypeSelect.addEventListener('change', updateItemsForSelectedType);
        
        submitBtn.addEventListener('click', function() {
            const employeeId = employeeIdInput.value.trim();
            const applicationNo = applicationNoInput.value.trim();
            const applicationType = applicationTypeSelect.value;
            
            if (!employeeId || !applicationNo || !applicationType) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„ç”³è«‹ä¿¡æ¯ï¼');
                return;
            }
            
            // ç²å–é¸ä¸­çš„é …ç›®
            const selectedItems = [];
            const checkboxes = applicationItemsDiv.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });
            
            if (selectedItems.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç”³è«‹é …ç›®ï¼');
                return;
            }
            
            // å‰µå»ºæ–°è¨˜éŒ„
            const newRecord = {
                employeeId,
                applicationNo,
                applicationType,
                selectedItems,
                timestamp: new Date().toISOString()
            };
            
            applicationData.records.push(newRecord);
            saveDataToLocal();
            displayRecords(searchInput.value, groupByEmployeeCheckbox.checked);
            
            // è‡ªå‹•ä¸Šå‚³åˆ° Gistï¼ˆå¦‚æœå·²è¨­ç½®ï¼‰
            if (syncConfig.githubToken && syncConfig.gistId) {
                uploadToGist();
            }
            
            // æ¸…ç©ºè¡¨å–®
            employeeIdInput.value = '';
            applicationNoInput.value = '';
            applicationTypeSelect.value = '';
            updateItemsForSelectedType();
            
            alert('ç”³è«‹æäº¤æˆåŠŸï¼');
        });

        // åŒæ­¥ç›¸é—œäº‹ä»¶
        saveSyncBtn.addEventListener('click', saveSyncConfig);
        syncDataBtn.addEventListener('click', syncData);

        // æœå°‹åŠŸèƒ½
        searchBtn.addEventListener('click', function() {
            displayRecords(searchInput.value, groupByEmployeeCheckbox.checked);
        });
        
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            displayRecords('', groupByEmployeeCheckbox.checked);
        });
        
        groupByEmployeeCheckbox.addEventListener('change', function() {
            displayRecords(searchInput.value, groupByEmployeeCheckbox.checked);
        });

        // åŒ¯å‡ºåŠŸèƒ½
        exportBtn.addEventListener('click', exportToExcel);

        // é¡å‹ç®¡ç†äº‹ä»¶
        addTypeBtn.addEventListener('click', function() {
            const newType = newTypeInput.value.trim();
            
            if (!newType) {
                alert('è«‹è¼¸å…¥ç”³è«‹å–®é¡å‹åç¨±ï¼');
                return;
            }
            
            if (applicationData.types.includes(newType)) {
                alert('è©²ç”³è«‹å–®é¡å‹å·²å­˜åœ¨ï¼');
                return;
            }
            
            applicationData.types.push(newType);
            applicationData.items[newType] = [];
            saveDataToLocal();
            updateTypeSelects();
            
            // è‡ªå‹•ä¸Šå‚³åˆ° Gistï¼ˆå¦‚æœå·²è¨­ç½®ï¼‰
            if (syncConfig.githubToken && syncConfig.gistId) {
                uploadToGist();
            }
            
            newTypeInput.value = '';
            alert(`æˆåŠŸæ–°å¢ç”³è«‹å–®é¡å‹: ${newType}`);
        });

        deleteTypeBtn.addEventListener('click', function() {
            const typeToDelete = typeToDeleteSelect.value;
            
            if (!typeToDelete) {
                alert('è«‹é¸æ“‡è¦åˆªé™¤çš„ç”³è«‹å–®é¡å‹ï¼');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç”³è«‹å–®é¡å‹ "${typeToDelete}" åŠå…¶æ‰€æœ‰é …ç›®å—ï¼Ÿ`)) {
                // å¾é¡å‹åˆ—è¡¨ä¸­åˆªé™¤
                applicationData.types = applicationData.types.filter(type => type !== typeToDelete);
                
                // å¾é …ç›®åˆ—è¡¨ä¸­åˆªé™¤
                delete applicationData.items[typeToDelete];
                
                saveDataToLocal();
                updateTypeSelects();
                updateItemsForSelectedType();
                
                // è‡ªå‹•ä¸Šå‚³åˆ° Gistï¼ˆå¦‚æœå·²è¨­ç½®ï¼‰
                if (syncConfig.githubToken && syncConfig.gistId) {
                    uploadToGist();
                }
                
                alert(`æˆåŠŸåˆªé™¤ç”³è«‹å–®é¡å‹: ${typeToDelete}`);
            }
        });

        // é …ç›®ç®¡ç†äº‹ä»¶
        typeForItemSelect.addEventListener('change', function() {
            // ç•¶é¸æ“‡é¡å‹æ™‚ï¼Œæ›´æ–°é …ç›®è¼¸å…¥æ¡†çš„æç¤º
            const selectedType = typeForItemSelect.value;
            if (selectedType) {
                newItemInput.placeholder = `æ–°å¢ ${selectedType} çš„ç”³è«‹é …ç›®`;
            } else {
                newItemInput.placeholder = 'æ–°å¢ç”³è«‹é …ç›®';
            }
        });

        typeForDeleteItemSelect.addEventListener('change', updateItemDeleteSelect);

        addItemBtn.addEventListener('click', function() {
            const selectedType = typeForItemSelect.value;
            const newItem = newItemInput.value.trim();
            
            if (!selectedType) {
                alert('è«‹å…ˆé¸æ“‡ç”³è«‹å–®é¡å‹ï¼');
                return;
            }
            
            if (!newItem) {
                alert('è«‹è¼¸å…¥ç”³è«‹é …ç›®åç¨±ï¼');
                return;
            }
            
            if (!applicationData.items[selectedType]) {
                applicationData.items[selectedType] = [];
            }
            
            if (applicationData.items[selectedType].includes(newItem)) {
                alert('è©²ç”³è«‹é …ç›®å·²å­˜åœ¨ï¼');
                return;
            }
            
            applicationData.items[selectedType].push(newItem);
            saveDataToLocal();
            
            // å¦‚æœç•¶å‰é¸æ“‡çš„é¡å‹èˆ‡é …ç›®æ·»åŠ çš„é¡å‹ç›¸åŒï¼Œæ›´æ–°é¡¯ç¤º
            if (applicationTypeSelect.value === selectedType) {
                updateItemsForSelectedType();
            }
            
            updateItemDeleteSelect();
            
            // è‡ªå‹•ä¸Šå‚³åˆ° Gistï¼ˆå¦‚æœå·²è¨­ç½®ï¼‰
            if (syncConfig.githubToken && syncConfig.gistId) {
                uploadToGist();
            }
            
            newItemInput.value = '';
            alert(`æˆåŠŸæ–°å¢ç”³è«‹é …ç›®: ${newItem}`);
        });

        deleteItemBtn.addEventListener('click', function() {
            const selectedType = typeForDeleteItemSelect.value;
            const itemToDelete = itemToDeleteSelect.value;
            
            if (!selectedType || !itemToDelete) {
                alert('è«‹é¸æ“‡è¦åˆªé™¤çš„ç”³è«‹é …ç›®ï¼');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç”³è«‹é …ç›® "${itemToDelete}" å—ï¼Ÿ`)) {
                applicationData.items[selectedType] = applicationData.items[selectedType].filter(
                    item => item !== itemToDelete
                );
                
                saveDataToLocal();
                
                // å¦‚æœç•¶å‰é¸æ“‡çš„é¡å‹èˆ‡é …ç›®åˆªé™¤çš„é¡å‹ç›¸åŒï¼Œæ›´æ–°é¡¯ç¤º
                if (applicationTypeSelect.value === selectedType) {
                    updateItemsForSelectedType();
                }
                
                updateItemDeleteSelect();
                
                // è‡ªå‹•ä¸Šå‚³åˆ° Gistï¼ˆå¦‚æœå·²è¨­ç½®ï¼‰
                if (syncConfig.githubToken && syncConfig.gistId) {
                    uploadToGist();
                }
                
                alert(`æˆåŠŸåˆªé™¤ç”³è«‹é …ç›®: ${itemToDelete}`);
            }
        });

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é é¢åŠ è¼‰å®Œæˆï¼Œåˆå§‹åŒ–ç³»çµ±...');
            loadData();
        });
    </script>
</body>
</html>